REPO = "devdocker.wifa.uni-leipzig.de:5000"
IMAGE_TAG = "transit/spring-access-control-core"
BUILD =  "main-stage"
node('master') {
  properties([disableConcurrentBuilds(abortPrevious: true)
    ] )
  checkout scm
  echo "Build: ${BUILD}"

  withCredentials([
    usernamePassword(credentialsId: 'docker-registry-devdocker', passwordVariable: 'DOCKER_PASSWORD', usernameVariable: 'DOCKER_USER')
    ]) {
    sh "sudo docker login -u ${DOCKER_USER} -p ${DOCKER_PASSWORD} ${REPO}"
  }
  stage('Build Docker image') {

    //sh "export DOCKER_BUILDKIT=1"
    echo "Build: ${BUILD}"
    dir("./access_control") {
        // Have to pull Dockerfile syntax container before building with DOCKER_BUILDKIT
      sh "sudo /bin/bash jenkinsdockerdownload.sh "
     sh "sudo apt-get update && sudo apt-get install -y dnsutils &&\
     sudo DOCKER_BUILDKIT=1  \
      docker build --network=host --add-host access-control-fine-grained-neo.transit-fine-grained-test.rancher.internal:\$(dig +short access-control-fine-grained-neo.transit-fine-grained-test.rancher.internal) \
    -f ./Dockerfile_rancher -t ${REPO}/${IMAGE_TAG}:${BUILD} ."
      sh "sudo docker push ${REPO}/${IMAGE_TAG}:${BUILD}"
      sh "sudo docker image prune -f --filter label=stage=builder-graph-based_v2-transit"
     }
     
    
    
  }
  }